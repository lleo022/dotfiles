#!/bin/bash
# Switch QuickShell theme

THEME_DIR="$HOME/.local/themes"
STATE_FILE="$HOME/.config/quickshell/state.json"

# Get available themes
THEMES=$(ls "$THEME_DIR"/*.json 2>/dev/null | xargs -n1 basename | sed 's/\.json$//')

if [ -z "$THEMES" ]; then
    notify-send "Theme Switcher" "No themes found" -i dialog-error
    exit 1
fi

# Select theme (use rofi, wofi, or fzf)
if command -v rofi &> /dev/null; then
    SELECTED=$(echo "$THEMES" | rofi -dmenu -p "Select theme" -i)
elif command -v wofi &> /dev/null; then
    SELECTED=$(echo "$THEMES" | wofi --dmenu -p "Select theme" -i)
elif command -v fzf &> /dev/null; then
    SELECTED=$(echo "$THEMES" | fzf --prompt="Select theme: ")
else
    notify-send "Theme Switcher" "Install rofi, wofi, or fzf" -i dialog-error
    exit 1
fi

if [ -z "$SELECTED" ]; then
    exit 0
fi

# Update state.json
if [ -f "$STATE_FILE" ]; then
    jq --arg theme "$SELECTED" '.theme = $theme' "$STATE_FILE" > "${STATE_FILE}.tmp"
    mv "${STATE_FILE}.tmp" "$STATE_FILE"
    
    notify-send "Theme Switcher" "Switched to $SELECTED" -i preferences-desktop-theme
else
    # Create initial state file
    mkdir -p "$(dirname "$STATE_FILE")"
    echo "{\"theme\": \"$SELECTED\", \"bar\": {\"height\": 36, \"position\": \"top\"}}" > "$STATE_FILE"
    
    notify-send "Theme Switcher" "Created state and set theme to $SELECTED" -i preferences-desktop-theme
fi